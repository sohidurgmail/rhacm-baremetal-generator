apiVersion: extensions.hive.openshift.io/v1beta1
kind: AgentClusterInstall
metadata:
  name: {{ multicluster_engine_managed_cluster.cluster_name }}
  namespace: {{ cluster_namespace }}
  labels:
    cluster-name: {{ multicluster_engine_managed_cluster.cluster_name }}
{% if multicluster_engine_managed_cluster.install_config_overrides is defined and multicluster_engine_managed_cluster.install_config_overrides %}
  annotations:
    agent-install.openshift.io/install-config-overrides: '{{ multicluster_engine_managed_cluster.install_config_overrides | to_json }}'
{% endif %}
spec:
{% if not multicluster_engine_managed_cluster.user_managed_networking %}
  apiVIP: {{ multicluster_engine_managed_cluster.api_vip }}
  ingressVIP: {{ multicluster_engine_managed_cluster.ingress_vip }}
{% endif %}
  clusterDeploymentRef:
    name: {{ multicluster_engine_managed_cluster.cluster_name }}
  imageSetRef:
    name: img{{ multicluster_engine_managed_cluster.ocp_release_image | regex_replace('_', '-',) }}-appsub
  provisionRequirements:
    controlPlaneAgents: {{ multicluster_engine_managed_cluster_control_plane_agents | int }}
    workerAgents: {{ multicluster_engine_managed_cluster_worker_agents | int }}
  controlPlane:
    hyperthreading: Enabled
    name: master
  compute:
  - hyperthreading: Enabled
    name: worker
  networking:
    clusterNetwork:
    - cidr: {{ multicluster_engine_managed_cluster.cluster_network_cidr }}
      hostPrefix: {{ multicluster_engine_managed_cluster.cluster_network_host_prefix }}
    serviceNetwork:
    - {{ multicluster_engine_managed_cluster.service_network_cidr }}
    userManagedNetworking: {{ multicluster_engine_managed_cluster.user_managed_networking }}
{% if multicluster_engine_managed_cluster.clusterwide_proxy %}
  proxy:
    httpProxy: {{ multicluster_engine_managed_cluster.clusterwide_proxy.http_proxy }}
    httpsProxy: {{ multicluster_engine_managed_cluster.clusterwide_proxy.https_proxy }}
    noProxy: {{ multicluster_engine_managed_cluster.clusterwide_proxy.no_proxy }}
{% endif %}
  sshPublicKey: '{{ multicluster_engine_managed_cluster.ssh_authorized_key }}'
